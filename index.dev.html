<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>记忆代理人 - 装备锻造台</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: #2b2b2b;
            --border-color: #555;
            --accent-color: #a855f7;
            --gold-color: #fbbf24;
            --text-color: #e5e5e5;
            --mc-tooltip-bg: rgba(16, 0, 16, 0.95);
            --mc-border: #2a002a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'DotGothic16', 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            background-image: url('https://assets.codepen.io/13471/dark-texture.png'); 
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            font-family: 'DotGothic16', sans-serif;
            color: #38bdf8; /* 标题蓝色 */
            text-shadow: 4px 4px 0px #0f4c75;
            margin-bottom: 10px;
            text-align: center;
            line-height: 1.5;
            font-size: 3rem;
            letter-spacing: 2px;
        }

        .subtitle {
            color: #888;
            margin-bottom: 30px;
            font-size: 0.9rem;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            width: 100%;
            max-width: 1200px;
        }

        /* 左侧配置区 */
        .config-panel {
            background: var(--panel-bg);
            border: 2px solid var(--border-color);
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .section-title {
            font-size: 1.2rem;
            color: var(--gold-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 20px;
            margin-bottom: 15px;
            font-weight: bold;
            font-family: 'DotGothic16', sans-serif;
        }
        .section-title:first-child { margin-top: 0; }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #ccc;
            letter-spacing: 1px;
        }

        input, select, textarea {
            width: 100%;
            background: #111;
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
            border-radius: 2px;
            font-family: inherit;
            letter-spacing: 2px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="range"] {
            flex: 1;
        }

        .attr-input-group {
            display: grid;
            grid-template-columns: 2fr 1fr 0.8fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
            background: rgba(0,0,0,0.2);
            padding: 5px 10px;
            border-radius: 4px;
        }

        .attr-price {
            font-size: 0.85rem;
            color: var(--gold-color);
            text-align: right;
            font-family: 'Press Start 2P', cursive;
        }

        /* 右侧预览区 */
        .preview-panel {
            position: sticky;
            top: 20px;
        }

        .price-card {
            background: linear-gradient(135deg, #2c0b38, #1a1a1a);
            border: 2px solid var(--accent-color);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.3);
        }

        .price-label { font-size: 0.9rem; color: #aaa; }
        .price-container {
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 10px;
            margin: 15px 0;
        }
        .total-price { 
            font-size: 2.5rem; 
            font-weight: bold; 
            color: var(--gold-color); 
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-family: 'Press Start 2P', cursive;
            display: inline-block;
            white-space: nowrap;
        }
        .currency { 
            font-size: 1.2rem; 
            color: #fff; 
            font-family: 'Press Start 2P', cursive;
        }

        .mc-tooltip {
            background-color: var(--mc-tooltip-bg);
            border: 3px solid #2a002a;
            border-top-color: #2a002a; /* Minecraft tooltips usually have a specific border style, simplified here */
            border-radius: 4px;
            padding: 12px;
            color: #fff;
            font-family: 'DotGothic16', sans-serif; /* 使用支持中文的像素字体 */
            line-height: 1.5;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            min-height: 300px;
            position: relative;
            font-size: 18px;
            letter-spacing: 1px;
        }

        /* Minecraft Color Codes Simulation */
        .mc-0 { color: #000000; }
        .mc-1 { color: #0000AA; }
        .mc-2 { color: #00AA00; }
        .mc-3 { color: #00AAAA; }
        .mc-4 { color: #AA0000; }
        .mc-5 { color: #AA00AA; }
        .mc-6 { color: #FFAA00; }
        .mc-7 { color: #AAAAAA; }
        .mc-8 { color: #555555; }
        .mc-9 { color: #5555FF; }
        .mc-a { color: #55FF55; }
        .mc-b { color: #55FFFF; }
        .mc-c { color: #FF5555; }
        .mc-d { color: #FF55FF; }
        .mc-e { color: #FFFF55; }
        .mc-f { color: #FFFFFF; }
        .mc-l { font-weight: bold; }
        .mc-m { text-decoration: line-through; }
        .mc-n { text-decoration: underline; }
        .mc-o { font-style: italic; }

        .action-btn {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background: var(--accent-color);
            color: white;
            border: none;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            clip-path: polygon(5% 0, 100% 0, 100% 90%, 95% 100%, 0 100%, 0 10%);
        }

        .action-btn:hover {
            background: #9333ea;
            transform: translateY(-2px);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <h1>记忆代理人 x 落花星雨</h1>
    <div class="subtitle">专属武器定制终端 - 打造属于你的传说</div>

    <div class="container">
        <!-- 左侧：配置面板 -->
        <div class="config-panel">
            
            <!-- 升级导入区 -->
            <div style="background: #222; border: 1px dashed #555; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleUpgradePanel()">
                    <span style="color: var(--accent-color); font-weight: bold; display: flex; align-items: center;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> 老客户升级 / 导入配置</span>
                    <span id="upgradeToggleIcon">▼</span>
                </div>
                <div id="upgradeInputPanel" style="display: none; margin-top: 10px;">
                    <textarea id="upgradeArea" rows="3" placeholder="请在此粘贴您之前的武器配置代码..." style="width: 100%; background: #111; color: #aaa; border: 1px solid #444; padding: 5px; font-size: 0.8rem;"></textarea>
                    <button class="action-btn" style="padding: 8px; font-size: 0.9rem; margin-top: 5px;" onclick="loadForUpgrade()">加载旧配置并升级</button>
                    <div id="upgradeMsg" style="font-size: 0.8rem; margin-top: 5px;"></div>
                </div>
            </div>
            
            <div class="section-title">基础信息</div>
            <div class="form-row">
                <div class="form-group">
                    <label>玩家 ID</label>
                    <input type="text" id="playerId" placeholder="输入你的游戏ID" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label>装备类型 (材质ID)</label>
                    <input type="text" id="itemMaterial" list="material_list" placeholder="输入材质英文名 (如 DIAMOND_SWORD)" oninput="updatePreview()" value="WOODEN_SWORD">
                    <datalist id="material_list">
                        <!-- 武器 -->
                        <option value="WOODEN_SWORD">木剑</option>
                        <option value="IRON_SWORD">铁剑</option>
                        <option value="DIAMOND_SWORD">钻石剑</option>
                        <option value="NETHERITE_SWORD">下界合金剑</option>
                        <option value="BOW">弓</option>
                        <option value="CROSSBOW">弩</option>
                        <option value="TRIDENT">三叉戟</option>
                        <option value="SHIELD">盾牌</option>
                        <option value="DIAMOND_AXE">钻石斧</option>
                        
                        <!-- 头盔 -->
                        <option value="LEATHER_HELMET">皮革帽子</option>
                        <option value="IRON_HELMET">铁头盔</option>
                        <option value="DIAMOND_HELMET">钻石头盔</option>
                        <option value="NETHERITE_HELMET">下界合金头盔</option>
                        
                        <!-- 胸甲 -->
                        <option value="LEATHER_CHESTPLATE">皮革外套</option>
                        <option value="IRON_CHESTPLATE">铁胸甲</option>
                        <option value="DIAMOND_CHESTPLATE">钻石胸甲</option>
                        <option value="NETHERITE_CHESTPLATE">下界合金胸甲</option>
                        
                        <!-- 护腿 -->
                        <option value="LEATHER_LEGGINGS">皮革裤子</option>
                        <option value="IRON_LEGGINGS">铁护腿</option>
                        <option value="DIAMOND_LEGGINGS">钻石护腿</option>
                        <option value="NETHERITE_LEGGINGS">下界合金护腿</option>
                        
                        <!-- 靴子 -->
                        <option value="LEATHER_BOOTS">皮革靴子</option>
                        <option value="IRON_BOOTS">铁靴子</option>
                        <option value="DIAMOND_BOOTS">钻石靴子</option>
                        <option value="NETHERITE_BOOTS">下界合金靴子</option>
                    </datalist>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>武器名称</label>
                    <input type="text" id="itemName" value="&c定制武器" maxlength="16" placeholder="最多10字 (含颜色代码限制16字符)" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label>装备部位</label>
                    <select id="itemSlot" onchange="updateVisibleAttributes()">
                        <option value="主手">主手</option>
                        <option value="副手">副手</option>
                        <option value="头盔">头盔</option>
                        <option value="胸甲">胸甲</option>
                        <option value="护腿">护腿</option>
                        <option value="靴子">靴子</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>背景故事 (最多5行，每行15字)</label>
                <textarea id="itemLore" rows="5" placeholder="输入背景故事..." oninput="validateLore(this)">由记忆碎片凝结而成。</textarea>
            </div>

            <div id="attributes-container">
                <!-- 属性将通过 JS 动态生成 -->
            </div>

        </div>

        <!-- 右侧：预览与结算 -->
        <div class="preview-panel">
            <div class="price-card">
                <div class="price-label">定制预估价格</div>
                <div class="price-container">
                    <span class="total-price" id="totalPrice">0</span>
                    <span class="currency">RMB</span>
                </div>
            </div>

            <div class="mc-tooltip" id="tooltipPreview">
                <!-- 预览内容 -->
            </div>

            <button class="action-btn" id="copyBtn" onclick="copyConfig()">复制配置代码</button>
            <div style="text-align: center; margin-top: 10px; font-size: 0.8rem; color: #666;">
                复制后请发送给管理员进行实装
            </div>

            <div id="adminPanel" style="margin-top: 30px; border-top: 2px dashed #444; padding-top: 20px; display: none;">
                <div class="section-title" style="font-size: 1rem;">管理员验证台</div>
                <textarea id="importArea" rows="3" placeholder="在此粘贴玩家发来的 YAML 配置代码以验证价格..." style="font-size: 0.8rem; height: 80px;"></textarea>
                <button class="action-btn" style="background: #444; margin-top: 10px; font-size: 0.9rem;" onclick="verifyConfig()">验证并导入配置</button>
                <div id="verifyResult" style="margin-top: 10px; font-size: 0.9rem; font-weight: bold; text-align: center;"></div>
            </div>
        </div>
    </div>

    <script>
        const SECRET_SALT = "MemoryAgent_Weapon_2026";

        // 升级模式状态
        let upgradeMode = false;
        let originalPrice = 0;

        // 签名提取 + 校验（仅用于“玩家下单/管理员验证”，升级导入不使用签名）
        function extractSignatureBase64(text) {
            if (!text) return null;
            // 仅支持当前格式（不兼容旧格式）
            const m = String(text).match(/(?:^|\n)\s*#\s*校验签名\s*[:：]\s*([A-Za-z0-9+/=]+)\s*(?:\n|$)/);
            return m && m[1] ? m[1] : null;
        }

        function decodeAndValidateSignData(yaml) {
            const b64 = extractSignatureBase64(yaml);
            if (!b64) {
                const err = new Error("SIGNATURE_NOT_FOUND");
                err.code = "SIGNATURE_NOT_FOUND";
                throw err;
            }

            // 清理掉复制过程中可能混入的空白/不可见字符
            const cleaned = b64.replace(/[^A-Za-z0-9+/=]/g, "");

            let signData;
            try {
                signData = JSON.parse(decodeURIComponent(escape(atob(cleaned))));
            } catch (e) {
                const err = new Error("SIGNATURE_DECODE_FAILED");
                err.code = "SIGNATURE_DECODE_FAILED";
                throw err;
            }

            if (!signData || typeof signData !== "object") {
                const err = new Error("SIGNATURE_INVALID_JSON");
                err.code = "SIGNATURE_INVALID_JSON";
                throw err;
            }

            if (signData.salt !== SECRET_SALT) {
                const err = new Error("INVALID_SALT");
                err.code = "INVALID_SALT";
                throw err;
            }

            const allowedSlots = ['主手', '副手', '头盔', '胸甲', '护腿', '靴子'];
            if (!allowedSlots.includes(signData.s)) {
                const err = new Error("INVALID_SLOT");
                err.code = "INVALID_SLOT";
                throw err;
            }

            const pNum = Number(signData.p);
            if (!Number.isFinite(pNum) || pNum < 0) {
                const err = new Error("INVALID_PRICE");
                err.code = "INVALID_PRICE";
                throw err;
            }

            // a: 属性表（可为空）
            if (signData.a != null && (typeof signData.a !== "object" || Array.isArray(signData.a))) {
                const err = new Error("INVALID_ATTRS");
                err.code = "INVALID_ATTRS";
                throw err;
            }

            const sanitizedAttrs = {};
            if (signData.a) {
                for (const [id, val] of Object.entries(signData.a)) {
                    const n = Number(val);
                    if (!Number.isFinite(n) || n < 0 || n > ATTR_INPUT_MAX) {
                        const err = new Error("INVALID_ATTR_VALUE");
                        err.code = "INVALID_ATTR_VALUE";
                        throw err;
                    }
                    sanitizedAttrs[id] = n;
                }
            }

            // 仅支持当前签名结构（不兼容旧结构）
            const mode = signData.m;
            if (mode !== 'custom' && mode !== 'upgrade') {
                const err = new Error("INVALID_MODE");
                err.code = "INVALID_MODE";
                throw err;
            }

            const fpNum = Number(signData.fp);
            if (!Number.isFinite(fpNum) || fpNum < 0) {
                const err = new Error("INVALID_FULL_PRICE");
                err.code = "INVALID_FULL_PRICE";
                throw err;
            }

            let opNum = undefined;
            if (mode === 'upgrade') {
                opNum = Number(signData.op);
                if (!Number.isFinite(opNum) || opNum < 0) {
                    const err = new Error("INVALID_ORIGINAL_PRICE");
                    err.code = "INVALID_ORIGINAL_PRICE";
                    throw err;
                }
            }

            return { ...signData, m: mode, op: opNum, fp: fpNum, p: pNum, a: sanitizedAttrs };
        }

        // 从 MythicMobs 配置（无签名）中解析装备类型 + 属性
        function stripMcFormatCodes(s) {
            if (!s) return '';
            return String(s)
                .replace(/&[0-9a-fk-or]/gi, '')   // &a &l ...
                .replace(/§[0-9a-fk-or]/gi, '')   // §a §l ...
                .trim();
        }

        function parseLoreLinesFromYaml(yaml) {
            const lines = String(yaml || '').split(/\r?\n/);
            const lore = [];
            let inLore = false;
            let loreIndent = null;

            for (const line of lines) {
                if (!inLore) {
                    if (/^\s*Lore\s*:\s*$/.test(line)) {
                        inLore = true;
                        loreIndent = null;
                    }
                    continue;
                }

                // 结束条件：缩进回退到 Lore 之前（或者进入 Options 等）
                if (/^\s*\S/.test(line) && !/^\s*-\s*/.test(line)) break;
                if (/^\s*Options\s*:\s*$/.test(line)) break;

                const m = line.match(/^(\s*)-\s*(.*)\s*$/);
                if (!m) continue;

                if (loreIndent == null) loreIndent = m[1].length;
                if (m[1].length < loreIndent) break;

                let raw = m[2] || '';
                // 去掉包裹引号
                if ((raw.startsWith("'") && raw.endsWith("'")) || (raw.startsWith('"') && raw.endsWith('"'))) {
                    raw = raw.slice(1, -1);
                }
                lore.push(raw);
            }
            return lore;
        }

        function buildLabelToAttrIdMap() {
            const map = new Map();
            Object.values(attributesDB).forEach(group => {
                group.forEach(attr => {
                    if (attr && attr.label) map.set(String(attr.label).trim(), attr.id);
                });
            });
            // 兼容：伤害在 lore 里用 “伤害”
            map.set('伤害', 'ap_attack');
            return map;
        }

        function parseUnsignedConfigForUpgrade(yaml) {
            const loreLinesRaw = parseLoreLinesFromYaml(yaml);
            const lore = loreLinesRaw.map(stripMcFormatCodes).filter(Boolean);

            // 解析装备类型
            let slot = null;
            for (const l of lore) {
                const m = l.match(/装备类型\s*[:：]\s*(.+)\s*$/);
                if (m) {
                    slot = m[1].trim();
                    break;
                }
            }

            const labelToId = buildLabelToAttrIdMap();
            const attrs = {};

            // 解析属性：形如 “PVP攻击: +2000” / “暴击几率: +10%”
            for (const l of lore) {
                const m = l.match(/^\s*([^:：]+)\s*[:：]\s*\+?\s*([0-9]+(?:\.[0-9]+)?)\s*(%)?\s*$/);
                if (!m) continue;
                const label = m[1].trim();
                const val = Number(m[2]);
                if (!Number.isFinite(val)) continue;
                const id = labelToId.get(label);
                if (!id) continue;
                attrs[id] = Math.max(0, Math.min(val, ATTR_INPUT_MAX));
            }

            return { slot, attrs };
        }

        function toggleUpgradePanel() {
            const panel = document.getElementById('upgradeInputPanel');
            const icon = document.getElementById('upgradeToggleIcon');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                icon.innerText = '▲';
            } else {
                panel.style.display = 'none';
                icon.innerText = '▼';
            }
        }

        function loadForUpgrade() {
            const yaml = document.getElementById('upgradeArea').value;
            const msgDiv = document.getElementById('upgradeMsg');
            
            if (!yaml) {
                msgDiv.innerHTML = "<span style='color: #ef4444;'>请先粘贴配置代码！</span>";
                return;
            }

            try {
                // 仅支持“无签名 MythicMobs 配置”导入（不兼容旧流程）
                // 注意：即使文本里包含 `# 校验签名:`，这里也会忽略签名，只按 Lore 解析为准。
                const parsed = parseUnsignedConfigForUpgrade(yaml);
                const slot = parsed.slot;
                const attrs = parsed.attrs || {};

                const allowedSlots = ['主手', '副手', '头盔', '胸甲', '护腿', '靴子'];
                if (!slot || !allowedSlots.includes(slot)) {
                    msgDiv.innerHTML = "<span style='color: #ef4444;'>导入失败：未能从配置中识别“装备类型”。请确保 Lore 中包含类似 `&e装备类型: 主手` 的一行。</span>";
                    return;
                }

                // 1) 恢复到界面
                document.getElementById('itemSlot').value = slot;
                updateVisibleAttributes();

                // 清空当前
                document.querySelectorAll('#attributes-container input').forEach(i => i.value = '');

                // 填入属性
                if (attrs) {
                    for (const [id, val] of Object.entries(attrs)) {
                        const input = document.getElementById(id);
                        if (input) input.value = val;
                    }
                }

                // 2) 计算“原始总价”作为升级基底
                const prevUpgradeMode = upgradeMode;
                const prevOriginalPrice = originalPrice;
                upgradeMode = false;
                originalPrice = 0;
                const baseFullPrice = calculatePrice();
                upgradeMode = prevUpgradeMode;
                originalPrice = prevOriginalPrice;

                upgradeMode = true;
                originalPrice = baseFullPrice;

                msgDiv.innerHTML =
                    `<span style='color: #22c55e;'><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: text-bottom; margin-right: 4px;"><polyline points="20 6 9 17 4 12"></polyline></svg> 加载成功！原始总价: ${originalPrice} RMB。请在下方修改属性，系统将自动计算补差价。</span>`;

                updatePreview();

            } catch (e) {
                console.error(e);
                msgDiv.innerHTML = "<span style='color: #ef4444;'>导入失败：配置解析异常。请确认你粘贴的是 MythicMobs 物品配置（含 Lore 列表），或是包含“校验签名”的完整配置。</span>";
            }
        }

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('admin') === 'true') {
            document.getElementById('adminPanel').style.display = 'block';
        }

        let titleClickCount = 0;
        document.querySelector('h1').addEventListener('click', () => {
            titleClickCount++;
            if (titleClickCount >= 5) {
                const panel = document.getElementById('adminPanel');
                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    alert('管理员验证台已开启');
                } else {
                    panel.style.display = 'none';
                }
                titleClickCount = 0;
            }
        });
        // 验证背景故事限制
        function validateLore(textarea) {
            const maxLines = 5;
            const maxChars = 15;
            
            let lines = textarea.value.split('\n');
            let modified = false;

            // 限制行数
            if (lines.length > maxLines) {
                lines = lines.slice(0, maxLines);
                modified = true;
            }

            // 限制每行字数
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].length > maxChars) {
                    lines[i] = lines[i].slice(0, maxChars);
                    modified = true;
                }
            }

            if (modified) {
                // 简单防抖，避免输入法冲突，但为了强限制直接赋值
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                textarea.value = lines.join('\n');
                // 尝试恢复光标
                try { textarea.setSelectionRange(start, end); } catch(e){}
            }
            
            updatePreview();
        }

        // 定义属性配置
        // costFactor: 价格系数
        // isPercent: 是否为百分比属性
        // baseCost: 开启该属性的基础费用
        // limit: 软上限，超过此值价格暴涨
        // 定义属性配置
        // allowed: ['weapon', 'armor', 'all'] - 允许的装备类型
        const attributesDB = {
            attack: [
                { id: 'ap_attack', name: '伤害', color: '&a', costFactor: 0.02, isPercent: false, limit: 5000, label: '伤害', allowed: ['weapon'] },
                { id: 'ap_pvp_attack', name: 'PVP攻击', color: '&a', costFactor: 0.01, isPercent: false, limit: 5000, label: 'PVP攻击', allowed: ['weapon'] },
                { id: 'ap_pve_attack', name: 'PVE攻击', color: '&a', costFactor: 0.01, isPercent: false, limit: 5000, label: 'PVE攻击', allowed: ['weapon'] },
                { id: 'ap_real_attack', name: '真实攻击', color: '&6', costFactor: 0.05, isPercent: false, limit: 5000, label: '真实攻击', allowed: ['weapon'] },
                { id: 'ap_fire', name: '燃烧几率', color: '&6', costFactor: 1, isPercent: true, limit: 50, label: '燃烧几率', allowed: ['weapon'] },
                { id: 'ap_fire_damage', name: '火焰攻击', color: '&6', costFactor: 0.01, isPercent: false, limit: 5000, label: '火焰攻击', allowed: ['weapon'] },
                { id: 'ap_crit', name: '暴击几率', color: '&c', costFactor: 1.5, isPercent: true, limit: 50, label: '暴击几率', allowed: ['weapon'] },
                { id: 'ap_crit_rate', name: '暴击倍率', color: '&c', costFactor: 3, isPercent: true, limit: 100, label: '暴击倍率', allowed: ['weapon'] },
                { id: 'ap_vampire', name: '吸血几率', color: '&c', costFactor: 3, isPercent: true, limit: 50, label: '吸血几率', allowed: ['weapon'] },
                { id: 'ap_vampire_rate', name: '吸血倍率', color: '&c', costFactor: 1, isPercent: true, limit: 50, label: '吸血倍率', allowed: ['weapon'] },
                { id: 'ap_hit', name: '命中几率', color: '&3', costFactor: 1, isPercent: true, limit: 50, label: '命中几率', allowed: ['weapon'] },
                { id: 'ap_frozen', name: '冰冻几率', color: '&3', costFactor: 1, isPercent: true, limit: 50, label: '冰冻几率', allowed: ['weapon'] },
                { id: 'ap_frozen_intensity', name: '冰冻强度', color: '&3', costFactor: 1, isPercent: true, limit: 50, label: '冰冻强度', allowed: ['weapon'] },
                { id: 'ap_lightning', name: '雷击几率', color: '&3', costFactor: 1, isPercent: true, limit: 50, label: '雷击几率', allowed: ['weapon'] },
                { id: 'ap_lightning_damage', name: '雷电攻击', color: '&3', costFactor: 0.01, isPercent: false, limit: 5000, label: '雷电攻击', allowed: ['weapon'] },
                { id: 'ap_sunder_armor', name: '破甲几率', color: '&3', costFactor: 2, isPercent: true, limit: 50, label: '破甲几率', allowed: ['weapon'] },
                { id: 'ap_see_through', name: '护甲穿透', color: '&6', costFactor: 5, isPercent: true, limit: 50, label: '护甲穿透', allowed: ['weapon'] },
                { id: 'ap_break_shield', name: '破盾几率', color: '&3', costFactor: 1, isPercent: true, limit: 50, label: '破盾几率', allowed: ['weapon'] },
            ],
            defense: [
                { id: 'ap_armor', name: '护甲值', color: '&a', costFactor: 5, isPercent: false, limit: 100, label: '护甲值', allowed: ['armor'] },
                { id: 'ap_defense', name: '防御', color: '&a', costFactor: 10, isPercent: false, limit: 50, label: '防御', allowed: ['armor'] },
                { id: 'ap_pvp_defense', name: 'PVP减伤', color: '&a', costFactor: 0.02, isPercent: false, limit: 5000, label: 'PVP减伤', allowed: ['armor'] },
                { id: 'ap_pve_defense', name: 'PVE减伤', color: '&a', costFactor: 0.02, isPercent: false, limit: 5000, label: 'PVE减伤', allowed: ['armor'] },
                { id: 'ap_crit_damage_resist', name: '暴伤抵抗', color: '&c', costFactor: 1, isPercent: true, limit: 50, label: '暴伤抵抗', allowed: ['armor'] },
                { id: 'ap_crit_resist', name: '暴击抵抗', color: '&c', costFactor: 1, isPercent: true, limit: 50, label: '暴击抵抗', allowed: ['armor'] },
                { id: 'ap_crit_dodge', name: '暴击闪避', color: '&c', costFactor: 1, isPercent: true, limit: 50, label: '暴击闪避', allowed: ['armor'] },
                { id: 'ap_vampire_dodge', name: '吸血闪避', color: '&c', costFactor: 1, isPercent: true, limit: 50, label: '吸血闪避', allowed: ['armor'] },
                { id: 'ap_vampire_resist', name: '吸血抵抗', color: '&c', costFactor: 1, isPercent: true, limit: 50, label: '吸血抵抗', allowed: ['armor'] },
                { id: 'ap_reflection', name: '反弹几率', color: '&6', costFactor: 2, isPercent: true, limit: 50, label: '反弹几率', allowed: ['armor'] },
                { id: 'ap_reflection_rate', name: '反弹倍率', color: '&6', costFactor: 1, isPercent: true, limit: 50, label: '反弹倍率', allowed: ['armor'] },
                { id: 'ap_dodge', name: '闪避几率', color: '&6', costFactor: 3, isPercent: true, limit: 50, label: '闪避几率', allowed: ['armor'] },
                { id: 'ap_shield_block', name: '盾牌格挡率', color: '&6', costFactor: 1, isPercent: true, limit: 50, label: '盾牌格挡率', allowed: ['armor'] },
                { id: 'ap_remote_immune', name: '箭伤免疫率', color: '&6', costFactor: 1, isPercent: true, limit: 50, label: '箭伤免疫率', allowed: ['armor'] },
            ],
            other: [
                { id: 'ap_health', name: '生命力', color: '&a', costFactor: 0.02, isPercent: false, limit: 10000, label: '生命力', allowed: ['armor'] },
                { id: 'ap_restore', name: '生命恢复', color: '&a', costFactor: 0.02, isPercent: false, limit: 1000, label: '生命恢复', allowed: ['armor'] },
                { id: 'ap_restore_ratio', name: '百分比恢复', color: '&a', costFactor: 10, isPercent: true, limit: 50, label: '百分比恢复', allowed: ['armor'] },
                { id: 'ap_accumulate_addition', name: '蓄力加成', color: '&6', costFactor: 1, isPercent: true, limit: 50, label: '蓄力加成', allowed: ['weapon'] },
                { id: 'ap_accumulate_disturb', name: '蓄力干扰', color: '&6', costFactor: 1, isPercent: true, limit: 50, label: '蓄力干扰', allowed: ['weapon'] },
                { id: 'ap_moving', name: '移速加成', color: '&6', costFactor: 1, isPercent: true, limit: 50, label: '移速加成', allowed: ['all'] },
                { id: 'ap_exp_addition', name: '经验加成', color: '&6', costFactor: 1, isPercent: true, limit: 300, label: '经验加成', allowed: ['all'] },
                { id: 'ap_shoot_speed', name: '弓箭射速', color: '&3', costFactor: 1, isPercent: true, limit: 50, label: '弓箭射速', allowed: ['weapon'] },
                { id: 'ap_shoot_spread', name: '箭术精准', color: '&3', costFactor: 1, isPercent: true, limit: 50, label: '箭术精准', allowed: ['weapon'] },
                { id: 'ap_shoot_through', name: '箭术穿透率', color: '&3', costFactor: 1, isPercent: true, limit: 50, label: '箭术穿透率', allowed: ['weapon'] },
            ]
        };

        // 属性输入框硬上限（防止超大数字导致 UI 溢出 / 计算异常）
        const ATTR_INPUT_MAX = 100000; // 10w

        function enforceAttrMax(input) {
            if (!input) return;
            const raw = input.value;
            if (raw === '') return;
            const n = Number(raw);
            if (!Number.isFinite(n)) {
                input.value = '';
                return;
            }
            if (n > ATTR_INPUT_MAX) input.value = String(ATTR_INPUT_MAX);
            if (n < 0) input.value = '0';
        }

        function enforceAllAttrMax() {
            document
                .querySelectorAll('#attributes-container input[type="number"]')
                .forEach(enforceAttrMax);
        }

        // 价格数字自适应（防止过长溢出价格卡片）
        let TOTAL_PRICE_BASE_FONT_PX = null;
        function adjustTotalPriceFontSize() {
            const priceEl = document.getElementById('totalPrice');
            if (!priceEl) return;

            const container = priceEl.closest('.price-container');
            if (!container) return;

            const currencyEl = container.querySelector('.currency');
            if (!currencyEl) return;

            if (TOTAL_PRICE_BASE_FONT_PX == null) {
                const base = parseFloat(getComputedStyle(priceEl).fontSize);
                TOTAL_PRICE_BASE_FONT_PX = Number.isFinite(base) && base > 0 ? base : 40;
            }

            // 先重置为基准字号再测量
            priceEl.style.fontSize = `${TOTAL_PRICE_BASE_FONT_PX}px`;

            const containerWidth = container.clientWidth;
            const currencyWidth = currencyEl.getBoundingClientRect().width;
            const gapStr = getComputedStyle(container).columnGap || getComputedStyle(container).gap || '0';
            const gap = parseFloat(gapStr) || 0;

            const available = containerWidth - currencyWidth - gap - 2; // 预留一点缓冲
            if (!(available > 0)) return;

            const priceWidth = priceEl.scrollWidth;
            if (priceWidth <= available) return; // 够放就不缩

            const scale = available / priceWidth;
            const clamped = Math.max(0.2, Math.min(1, scale));
            priceEl.style.fontSize = `${TOTAL_PRICE_BASE_FONT_PX * clamped}px`;
        }

        window.addEventListener('resize', () => requestAnimationFrame(adjustTotalPriceFontSize));

        // 初始化页面
        function init() {
            const container = document.getElementById('attributes-container');
            
            const createSection = (title, attrs) => {
                let html = `<div class="section-title">${title}</div>`;
                attrs.forEach(attr => {
                    const step = attr.isPercent ? 1 : (attr.id.includes('attack') || attr.id.includes('health') ? 10 : 1);
                    const suffix = attr.isPercent ? '%' : '';
                    const placeholder = attr.isPercent ? '0-100' : '数值';
                    
                    html += `
                    <div class="attr-input-group">
                        <label>${parseMcColor(attr.color + attr.name)}</label>
                        <input type="number" 
                            id="${attr.id}" 
                            data-is-percent="${attr.isPercent}"
                            data-cost="${attr.costFactor}"
                            data-limit="${attr.limit}"
                            data-mc-color="${attr.color}"
                            data-label="${attr.label}"
                            data-allowed='${JSON.stringify(attr.allowed)}'
                            placeholder="0" 
                            step="${step}"
                            oninput="enforceAttrMax(this); updatePreview()"
                            min="0"
                            max="${ATTR_INPUT_MAX}">
                        <span id="price-${attr.id}" class="attr-price"></span>
                    </div>`;
                });
                return html;
            };

            container.innerHTML += createSection('攻击属性 (仅限武器)', attributesDB.attack);
            container.innerHTML += createSection('防御属性 (仅限装备栏)', attributesDB.defense);
            container.innerHTML += createSection('特殊属性 (部分通用)', attributesDB.other);

            updateVisibleAttributes(); // 初始化时更新可见性
            updatePreview();
        }

        // 监听装备部位变化
        function updateVisibleAttributes() {
            const slot = document.getElementById('itemSlot').value;
            let currentType = 'weapon'; // 默认为武器类型

            if (['头盔', '胸甲', '护腿', '靴子'].includes(slot)) {
                currentType = 'armor';
            }

            const inputs = document.querySelectorAll('#attributes-container input');
            inputs.forEach(input => {
                let allowed = [];
                try {
                    allowed = JSON.parse(input.dataset.allowed || '[]');
                } catch (e) {
                    console.error('JSON Parse error', e);
                }
                
                const container = input.closest('.attr-input-group');
                
                // 检查是否允许显示
                const isAllowed = allowed.includes('all') || allowed.includes(currentType);

                if (isAllowed) {
                    container.style.display = 'grid';
                } else {
                    container.style.display = 'none';
                    input.value = ''; // 隐藏时清空数值
                    // 清空价格显示
                    const priceSpan = document.getElementById(`price-${input.id}`);
                    if (priceSpan) {
                        priceSpan.innerText = '';
                        priceSpan.style.opacity = '0';
                    }
                }
            });
            
            updatePreview(); // 状态改变后更新预览
        }

        // 价格计算逻辑
        function calculatePrice() {
            enforceAllAttrMax();
            let totalPrice = 0; // 基础价格从0开始计算
            const slot = document.getElementById('itemSlot').value;
            
            // 确定部位倍率
            let slotMultiplier = 1.0;
            if (slot === '副手') {
                slotMultiplier = 2.0; // 副手双倍价格
            }

            const inputs = document.querySelectorAll('#attributes-container input');
            inputs.forEach(input => {
                // 如果被隐藏了（display: none），则不计算价格
                const container = input.closest('.attr-input-group');
                if (container && container.style.display === 'none') return;

                let val = parseFloat(input.value);
                let cost = 0;
                
                if (val && val > 0) {
                    const costFactor = parseFloat(input.dataset.cost);
                    const limit = parseFloat(input.dataset.limit);
                    
                    // 核心定价算法
                    // 1. 基础线性价格
                    cost = val * costFactor;

                    // 2. 惩罚性指数增长
                    if (val > limit) {
                        const excessRatio = (val - limit) / limit;
                        cost += cost * excessRatio * 2; 
                    }
                    
                    // 应用部位倍率
                    cost = cost * slotMultiplier;
                }

                // 更新单个属性的价格显示
                const priceSpan = document.getElementById(`price-${input.id}`);
                if (priceSpan) {
                    if (cost > 0) {
                        priceSpan.innerText = `+${Math.ceil(cost)}`;
                        priceSpan.style.opacity = '1';
                    } else {
                        priceSpan.innerText = '';
                        priceSpan.style.opacity = '0';
                    }
                }

                totalPrice += cost;
            });

            // 最低消费 50
            let finalPrice = Math.ceil(Math.max(totalPrice, 50));

            if (upgradeMode) {
                // 升级模式：计算差价
                let diff = finalPrice - originalPrice;
                // 至少显示 0，或者可以设置一个最小升级手续费
                return Math.max(diff, 0); 
            }

            return finalPrice;
        }

        // Minecraft 颜色代码解析 (修复版：正确处理样式继承和重置)
        function parseMcColor(text) {
            if (!text) return '';
            
            let html = '';
            let currentColor = ''; // 当前颜色类名
            let currentFormats = new Set(); // 当前格式类名集合
            
            const parts = text.split('&');
            
            // 处理第一个 & 之前的内容
            if (parts[0]) {
                html += parts[0];
            }
            
            for (let i = 1; i < parts.length; i++) {
                const part = parts[i];
                if (part.length === 0) continue; 
                
                const code = part.charAt(0).toLowerCase();
                const content = part.substring(1);
                
                // 判断代码类型
                if ('0123456789abcdef'.includes(code)) {
                    // 颜色代码：更新颜色，清空格式 (Minecraft 机制)
                    currentColor = `mc-${code}`;
                    currentFormats.clear();
                } else if ('lmnok'.includes(code)) {
                    // 格式代码：添加格式
                    currentFormats.add(`mc-${code}`);
                } else if (code === 'r') {
                    // 重置代码
                    currentColor = '';
                    currentFormats.clear();
                }
                
                if (content.length > 0) {
                    // 生成 span
                    let classes = [];
                    if (currentColor) classes.push(currentColor);
                    currentFormats.forEach(f => classes.push(f));
                    
                    if (classes.length > 0) {
                        html += `<span class="${classes.join(' ')}">${content}</span>`;
                    } else {
                        html += content;
                    }
                }
            }
            
            return html;
        }

        // 更新预览和价格
        function updatePreview() {
            const price = calculatePrice();
            document.getElementById('totalPrice').innerText = price;
            requestAnimationFrame(adjustTotalPriceFontSize);

            const name = document.getElementById('itemName').value || '未命名武器';
            const slot = document.getElementById('itemSlot').value;
            const loreRaw = document.getElementById('itemLore').value;
            const playerId = document.getElementById('playerId').value || 'Player';

            let loreHtml = '';
            
            // 头部
            loreHtml += parseMcColor(name + '&c[右键绑定]') + '<br><br>';
            loreHtml += parseMcColor('&7&l&m----------&6&l武器描述&7&l&m---------') + '<br>';
            loreHtml += parseMcColor('&0.') + '<br>';
            loreHtml += parseMcColor('&e最上级<100%>&0............&e定制') + '<br>';
            loreHtml += parseMcColor('&d可升级') + '<br>';
            loreHtml += parseMcColor(`&e装备类型: ${slot}`) + '<br>';
            loreHtml += parseMcColor('&0.') + '<br>';

            // 属性部分
            let hasAttr = false;
            
            // 1. 先找伤害显示在上面 (模仿 AttributePlus 风格或商城风格)
            const inputs = Array.from(document.querySelectorAll('#attributes-container input'));
            
            // 寻找伤害
            const dmgInput = inputs.find(i => i.id === 'ap_attack');
            if (dmgInput && dmgInput.value > 0) {
                 loreHtml += parseMcColor(`&b&l伤害:&2&l +${dmgInput.value}`) + '<br>';
            }

            loreHtml += parseMcColor('&7&l&m----------&6&l武器属性&7&l&m---------') + '<br>';
            
            inputs.forEach(input => {
                const val = parseFloat(input.value);
                if (val > 0 && input.id !== 'ap_attack') { // 伤害已经显示过了
                    const label = input.dataset.label;
                    const color = input.dataset.mcColor;
                    const isPercent = input.dataset.isPercent === 'true';
                    const suffix = isPercent ? '%' : '';
                    
                    // 格式：&f&l属性名:&2&l +数值%
                    loreHtml += parseMcColor(`${color}&l${label}:&2&l +${val}${suffix}`) + '<br>';
                    hasAttr = true;
                }
            });

            if (!hasAttr && (!dmgInput || dmgInput.value <= 0)) {
                loreHtml += parseMcColor('&7(暂无附加属性)') + '<br>';
            }

            // 尾部故事
            loreHtml += parseMcColor('&7&l&m----------&6&l背景故事&7&l&m---------') + '<br>';
            loreHtml += parseMcColor('&0.') + '<br>';
            
            const loreLines = loreRaw.split('\n');
            loreLines.forEach(line => {
                if(line.trim()) loreHtml += parseMcColor(`&7&o${line}`) + '<br>';
            });
            loreHtml += parseMcColor('&0.') + '<br>';

            document.getElementById('tooltipPreview').innerHTML = loreHtml;
        }

        // 生成 YAML 并复制
        function copyConfig() {
            const playerId = document.getElementById('playerId').value || 'CustomItem';
            const material = document.getElementById('itemMaterial').value;
            const name = document.getElementById('itemName').value;
            const slot = document.getElementById('itemSlot').value;
            const loreRaw = document.getElementById('itemLore').value;
            const price = document.getElementById('totalPrice').innerText;

            // 构建 Lore 数组
            let loreList = [];
            loreList.push('');
            loreList.push('&7&l&m----------&6&l武器描述&7&l&m---------');
            loreList.push('&0.');
            loreList.push('&e最上级<100%>&0............&e定制');
            loreList.push('&d可升级');
            loreList.push(`&e装备类型: ${slot}`);
            loreList.push('&0.');

            // 收集所有有效属性
            const inputs = Array.from(document.querySelectorAll('#attributes-container input'));
            const activeAttrs = {};
            
            inputs.forEach(input => {
                const val = parseFloat(input.value);
                const container = input.closest('.attr-input-group');
                // 只有非隐藏且有值的属性才会被记录
                if (val > 0 && container.style.display !== 'none') {
                    activeAttrs[input.id] = val;
                }
            });

            // 生成 Lore
            // 1. 伤害优先
            if (activeAttrs['ap_attack']) {
                 loreList.push(`&b&l伤害:&2&l +${activeAttrs['ap_attack']}`);
            }

            loreList.push('&7&l&m----------&6&l武器属性&7&l&m---------');

            inputs.forEach(input => {
                if (activeAttrs[input.id] && input.id !== 'ap_attack') {
                    const label = input.dataset.label;
                    const color = input.dataset.mcColor;
                    const isPercent = input.dataset.isPercent === 'true';
                    const suffix = isPercent ? '%' : '';
                    loreList.push(`${color}&l${label}:&2&l +${activeAttrs[input.id]}${suffix}`);
                }
            });

            loreList.push('&7&l&m----------&6&l背景故事&7&l&m---------');
            loreList.push('&0.');
            loreRaw.split('\n').forEach(line => {
                if(line.trim()) loreList.push(`&7&o${line}`);
            });
            loreList.push('&0.');

            // 计算当前总价（忽略 upgradeMode，避免得到补价）
            const prevUpgradeMode = upgradeMode;
            const prevOriginalPrice = originalPrice;
            upgradeMode = false;
            const fullPriceNow = calculatePrice();
            upgradeMode = prevUpgradeMode;
            originalPrice = prevOriginalPrice;

            // 当前应付金额：定制=总价，升级=补差价
            const payPrice = upgradeMode ? Math.max(fullPriceNow - originalPrice, 0) : fullPriceNow;

            // 生成校验签名（仅用于管理员验证；不做旧格式兼容）
            const signData = {
                m: upgradeMode ? 'upgrade' : 'custom',
                p: String(payPrice),
                fp: fullPriceNow,
                op: upgradeMode ? originalPrice : undefined,
                s: slot,
                a: activeAttrs,
                t: Date.now(),
                salt: SECRET_SALT
            };
            // 简单的 Base64 编码作为签名 (防小白修改)
            // 修复：btoa 不支持中文，需要先 encodeURIComponent
            const signature = btoa(unescape(encodeURIComponent(JSON.stringify(signData))));

            // 格式化 YAML
            let yamlHeader = upgradeMode 
                ? `# 玩家升级订单 - 补价: ${payPrice} RMB (原价: ${originalPrice})\n`
                : `# 玩家定制订单 - 价格: ${payPrice} RMB\n`;
            
            let yaml = yamlHeader;
            yaml += `# 校验签名: ${signature}\n`; // 关键行
            yaml += `${playerId}_Custom:\n`;
            yaml += `  Id: ${material}\n`;
            yaml += `  Data: 0\n`;
            yaml += `  Display: '${name}§c[右键绑定]'\n`;
            yaml += `  Lore:\n`;
            loreList.forEach(l => {
                yaml += `    - '${l}'\n`;
            });
            yaml += `  Options:\n`;
            yaml += `    Unbreakable: true\n`;
            yaml += `    HideFlags: true\n`;

            // 复制到剪贴板
            navigator.clipboard.writeText(yaml).then(() => {
                const btn = document.getElementById('copyBtn');
                const originalText = btn.innerText;
                btn.innerText = "已复制到剪贴板！";
                btn.style.background = "#22c55e";
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.background = "";
                }, 2000);
            });
        }

        // 验证配置
        function verifyConfig() {
            const yaml = document.getElementById('importArea').value;
            const resultDiv = document.getElementById('verifyResult');
            
            if (!yaml) {
                resultDiv.innerText = "请先粘贴 YAML 配置代码！";
                resultDiv.style.color = "#ef4444";
                return;
            }

            try {
                const signData = decodeAndValidateSignData(yaml);

                // 恢复数据到界面
                // 1. 恢复部位 (必须先恢复部位，否则 updateVisibleAttributes 会隐藏属性导致无法赋值)
                document.getElementById('itemSlot').value = signData.s;
                updateVisibleAttributes(); // 触发界面更新，显示该显示的属性框

                // 2. 清空所有输入
                document.querySelectorAll('#attributes-container input').forEach(i => i.value = '');

                // 3. 填入属性
                if (signData.a) {
                    for (const [id, val] of Object.entries(signData.a)) {
                        const input = document.getElementById(id);
                        if (input) {
                            input.value = val;
                        }
                    }
                }

                // 4. 重新计算当前“总价”（必须忽略 upgradeMode，避免返回补价）
                const prevUpgradeMode = upgradeMode;
                const prevOriginalPrice = originalPrice;
                upgradeMode = false;
                const fullPriceNow = calculatePrice();
                upgradeMode = prevUpgradeMode;
                originalPrice = prevOriginalPrice;

                // 5. 根据订单类型验证金额
                const payFromSign = Number(signData.p);
                const mode = signData.m;

                if (mode === 'upgrade') {
                    const op = Number(signData.op);
                    const expectedPay = Math.max(fullPriceNow - op, 0);
                    if (expectedPay == payFromSign) {
                        resultDiv.innerHTML = `<span style='color: #22c55e;'><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: text-bottom; margin-right: 4px;"><polyline points="20 6 9 17 4 12"></polyline></svg> 验证通过！(升级订单)</span><br>原价: ${op} | 当前总价: ${fullPriceNow} | 应补: ${expectedPay}`;
                    } else {
                        resultDiv.innerHTML = `<span style='color: #fbbf24;'><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: text-bottom; margin-right: 4px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> 警告：补价不匹配！(升级订单)</span><br>签名补价: ${payFromSign} | 计算应补: ${expectedPay}<br>原价: ${op} | 当前总价: ${fullPriceNow}`;
                    }

                    updatePreview();
                    return;
                }
                
                // 定制订单：验证总价一致性
                if (fullPriceNow == payFromSign) {
                    resultDiv.innerHTML = `<span style='color: #22c55e;'><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: text-bottom; margin-right: 4px;"><polyline points="20 6 9 17 4 12"></polyline></svg> 验证通过！</span><br>签名价格: ${payFromSign} | 当前计算: ${fullPriceNow}<br>配置已导入界面，您可以检查属性是否正确。`;
                    updatePreview(); // 更新预览
                } else {
                    resultDiv.innerHTML = `<span style='color: #fbbf24;'><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: text-bottom; margin-right: 4px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> 警告：价格不匹配！</span><br>签名价格: ${payFromSign} | 当前计算: ${fullPriceNow}<br>可能原因：玩家修改了属性、P图改了价格，或者您的计费规则已更新。`;
                    updatePreview();
                }

            } catch (e) {
                console.error(e);
                if (e && e.code === "SIGNATURE_NOT_FOUND") {
                    resultDiv.innerHTML = "<span style='color: #ef4444;'><svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round' style='vertical-align: text-bottom; margin-right: 4px;'><line x1='18' y1='6' x2='6' y2='18'></line><line x1='6' y1='6' x2='18' y2='18'></line></svg> 错误：未找到“校验签名”。请粘贴包含签名行的完整配置（若从渲染后的 Markdown 复制，可能丢失 # 号）。</span>";
                } else if (e && e.code === "INVALID_SALT") {
                    resultDiv.innerHTML = "<span style='color: #ef4444;'><svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round' style='vertical-align: text-bottom; margin-right: 4px;'><line x1='18' y1='6' x2='6' y2='18'></line><line x1='6' y1='6' x2='18' y2='18'></line></svg> 错误：签名不匹配（可能是伪造/旧版本/被篡改）。</span>";
                } else {
                    resultDiv.innerHTML = "<span style='color: #ef4444;'><svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round' style='vertical-align: text-bottom; margin-right: 4px;'><line x1='18' y1='6' x2='6' y2='18'></line><line x1='6' y1='6' x2='18' y2='18'></line></svg> 错误：签名解析失败，配置可能已损坏！</span>";
                }
            }
        }

        init();
    </script>
</body>
</html>